---
title: "Différents tests sur les indices de diversité"
author: "Marion Lemer"
date: '2022-05-04'
output: html_document
---

```{r, include=FALSE}
library(tidyverse)
library(vegan)
library(fossil)
```

## I) Bilan sur matrix_OTU :

```{r}
<<<<<<< HEAD
load('/Users/martind/Desktop/DATA_PROJECT_1.RData')

=======
load('C:/Users/33638/Documents/stage/MICROBIOTA_SPATIAL_FLIGHT/DATA_PROJECT_1.RData')
>>>>>>> 035c0bfb7fd3a8c26c6f41c73d34c5dd15caf33c
id <- row.names(matrix_otu)
matrix_otu <- tibble(data.frame(matrix_otu))
row.names(matrix_otu) <- id
ncol(matrix_otu)  #627 OTU
nrow(matrix_otu)  #28 individus : en réalité que 14, on a D0 et D5 pour chaque individu
```

La table a pour particularité d'avoir énormément de 0 (sparse data):

```{r}
z <- sum(apply(matrix_otu, 2, function(x) length(x[x==0]))) # Nombre de 0
z
# soit une proportion de :
z*100/(nrow(matrix_otu)*ncol(matrix_otu))
```

On compte pour chaque individu (donc sur chaque ligne) le nombre de fois où une bactérie est apparue moins de 5 fois:  

1 fois :

```{r}
#pour les 28 individus, le nombre de fois où un OTU est apparu 1 fois
apply(matrix_otu, 1, function(x) length(x[x==1]))
#proportion totale de 1:
sum(apply(matrix_otu, 1, function(x) length(x[x==1])))*100/(nrow(matrix_otu)*ncol(matrix_otu))

```

2 fois :

```{r}
#pour les 28 individus, le nombre de fois où un OTU est apparu 2 fois
apply(matrix_otu, 1, function(x) length(x[x==2]))
#proportion totale de 2:
sum(apply(matrix_otu, 1, function(x) length(x[x==2])))*100/(nrow(matrix_otu)*ncol(matrix_otu))
```

3 fois :

```{r}
#pour les 28 individus, le nombre de fois où un OTU est apparu 3 fois
apply(matrix_otu, 1, function(x) length(x[x==3]))
#proportion totale de 3:
sum(apply(matrix_otu, 1, function(x) length(x[x==3])))*100/(nrow(matrix_otu)*ncol(matrix_otu))
```

4 fois :

```{r}
#pour les 28 individus, le nombre de fois où un OTU est apparu 4 fois
apply(matrix_otu, 1, function(x) length(x[x==4]))
#proportion totale de 4:
sum(apply(matrix_otu, 1, function(x) length(x[x==4])))*100/(nrow(matrix_otu)*ncol(matrix_otu))
```

```{r}
#pour les 28 individus, le nombre de fois où un OTU est apparu 5 fois
apply(matrix_otu, 1, function(x) length(x[x==5]))
#proportion totale de 5:
sum(apply(matrix_otu, 1, function(x) length(x[x==5])))*100/(nrow(matrix_otu)*ncol(matrix_otu))
```

Nombre de fois qu'un OTU apparait au maximum
```{r}
# Au maximum, si on s'intéresse au total des OTU (somme sur les 28 individus), on a un OTU qui apparait 39955 fois (Cluster_1)
occurence_max_tot = sort(apply(matrix_otu,2,FUN = sum),decreasing = TRUE)[1]
occurence_max_tot

```

```{r}
# Au maximum, on a pour un individu 3502 fois le même OTU (individu 3, BG-B-D0-CTL)
occurence_max_ind = sort(apply(matrix_otu,1,FUN = max),decreasing=TRUE)[1]
occurence_max_ind
```

Globalement on peut tracer un histogramme avec en abscisses le nb d'apparition de l'OTU, et l'effectif associé (càd le nombre de fois où une bactérie est apparue 1x...)

Rq : Pas vraiment courbe d'abondance où ce serait les 627 OTU en abscisses , classés par ordre décroissant d'effectif, et avec effectifs en ordonnées.



```{r}
# Choix de l'indiv
ind="BG-B-D0-CTL"

proportion_occurence = c()

for(i in 0:max(matrix_otu[ind,])){
  nv_prop=sum(matrix_otu[ind,]==i)*100/ncol(matrix_otu)
  proportion_occurence=c(proportion_occurence,nv_prop)
}

#barplot(proportion_occurence) #on ne voit pas grand chose en laissant les 0

plot(proportion_occurence[2:length(proportion_occurence)],xlab="Comptage de l'OTU",ylab="Poucentage d'OTU concernés",main=paste("Pourcentage d'OTU qui apparaissent un nombre x \n de fois (en abscisses) pour l'indiv ",ind),type="l")

```

Remarques :  
- Ici on a pas représenté les pourcentages de 0, mais ils sont  majoritaires à plus de 50%.  
- On voit que les OTU à faibles effectifs d'apparition sont majoritaires => on compte souvent une seule fois, ou 2 fois un OTU.  
- et qu'on a quelques pics correspondants à des OTU qui ont été comptés beaucoup de fois (par exemple 3502), mais cette valeur de comptage est unique (faible pourcentage en ordonnée)  => cela est logique, faible proba de compter exactement 3502 fois exactement un OTU.

Cet état des lieux de la base de données va permettre par la suite de nuancer les indicateurs de diversité 


```{r}

```



# 2) Normalisation 
TSS?
Pour l'instant je laisse données brutes, il faudra voir quelle normalisation appliquer
```{r}
OTU_normalised <- matrix_otu
```


# 3)  Diversité

## La richesse spécifique
```{r}
#richesse totale
RICHNESS<-apply(OTU_normalised, 1, function(x) length(which(x>=1)))
   #La richesse varie entre 209 et 316 selon les individus, avec une moyenne de 273 OTU différents détectés
range(RICHNESS)
mean(RICHNESS)

#richesse en enlevant OTU apparus 1 fois
RICHNESS_1 <- apply(OTU_normalised, 1, function(x) length(which(x>1)))
#richesse en enlevant OTU apparus moins de 5 fois
RICHNESS_5 <- apply(OTU_normalised, 1, function(x) length(which(x>=5)))
#richesse en enlevant OTU apparus moins de 10 fois
RICHNESS_10 <- apply(OTU_normalised, 1, function(x) length(which(x>=10)))

```

On représente cette richesse spécifique :
```{r}
plot(RICHNESS, ylim=range(RICHNESS, RICHNESS_10), ylab='Richness', xlab='ind',main="Richesse spécifique pour chacun des 28 individus, \n avec matrice filtrée ou non")
points(RICHNESS_1, col='blue')
points(RICHNESS_5, col='red')
points(RICHNESS_10, col='green3')
legend('topleft', legend=c("Aucun",1,5,10), fill = c('black','blue', "red", "green3"), title='FILTRES', horiz = T)
```

### Richesse et profondeur de séquençage
```{r}
barplot(sort(apply(matrix_otu, 1, sum),decreasing = TRUE), ylab='Profondeur de sequencage', xlab='sujets',main="Profondeur de séquençage selon les individus")

```

ON voit que selon les sujets, la profondeur de séquençage peut presque passer du simple au double ()
```{r}
profondeur_seq <- sort(apply(matrix_otu, 1, sum),decreasing = TRUE)
profondeur_seq[28]   #ind min : BG-I-D0-CTL, 7414 séquences 
profondeur_seq[1]    #ind max : BG-G-D0-CUFF, 15392 séquences
```

#### Courbe de Raréfaction
On regarde si la profondeur de séquençage semble suffisante pour atteindre un plateau dans la richesse.

```{r}
rarecurve(matrix_otu, step=20,label=FALSE)

```

La courbe pour l'individu avec la profondeur de séquençage minimale (BG-I-D0-CTL ):
```{r}
rarecurve(matrix_otu["BG-I-D0-CTL",], step=20)
```


La courbe pour l'individu avec la profondeur de séquençage maximale (BG-G-D0-CUFF ):
```{r}
rarecurve(matrix_otu["BG-G-D0-CUFF",], step=20)
```

Même s'il y a une convergence, peut-on vraiment parler de plateau ?


### Chao1 
Le chao1 estime la richesse de la population en utilisant les OTU observés 1 ou 2 fois

Calculons le Chao1 pour les 28 sujets :
```{r}
CHAO1<-apply(matrix_otu, 1, function(x) chao1(x, taxa.row = T))
```

On compare ces valeurs avec la richesse spécifique :
```{r}
plot(RICHNESS, ylab='Richness / Chao1', xlab='ind',main="Richesse (noir) VS Chao1 (rouge) pour chacun des 28 individus",pch=3,ylim=c(min(RICHNESS),max(CHAO1)))
points(CHAO1, col='red',pch=3)
```

Pour tous les individus, le Chao1 estime une richesse réelle supérieure à la richesse spécifique.

Se pose alors la question de la pertinence de l'indicateur Chao1: comme vu précédemment les données comportent énormément d'OTU détectés 1 ou 2 fois, mais c'est une chose "normale", certains OTU sont rares. 
Ainsi on peut avoir deux réflexions:  
- Soit se dire que le Chao1 est quand même cohérent : la profondeur de séquençage n'a pas permis de détecter certains OTU rares => la courbe de raréfaction reste ambigue sur ce point.  
- Soit se dire que de toutes façons ces OTU (hypothétiques) très rares ne sont pas essentiels à l'analyse, et que le Chao1 crée un biais inutile. 
```{r}
plot(CHAO1-RICHNESS, main="Différence Chao1-Richesse spécifique")
abline(h=mean(CHAO1-RICHNESS),col="blue")
```

En moyenne, le chao1 estime que la vraie richesse est supérieure de 40 OTU à la richesse spécifique.

On construit une fonction qui va permettre de regarder l'évolution du Chao1 (comparé à la richesse spécifique) pour un individu choisi.
On peut choisir un éventuel filtre :  
- si le filtre_inf est laissé à 0 et le filtre_sup laissé à max(ind) (valeurs par défaut), ce sont l'ensemble des OTU détectés pour l'indiv qui sont conservés.  
La fonction renvoie un dataframe (pour l'individu concerné) avec 3 colonnes: la profondeur de séquencage, l'évolution de la richesse spécifique et l'évolution du chao1.

```{r}

RARE_CURVE_RICHNESS_CHAO <- function(indiv,filtre_inf = 0,filtre_sup = max(ind)){
      #on choisit un individu 
      ind= matrix_otu[indiv,]
      ind= t(ind[which(ind>filtre_inf & ind<=filtre_sup)])
      
      # On veut passer d'un vecteur de comptage aux données de séquençage d'origine
      # on va donc répéter le nom des OTU autant de fois qu'ils ont été comptés et en faire un vecteur
      sequencage=NULL
      for (i in 1:length(ind)){
        new=rep(rownames(ind)[i], ind[i])
        sequencage=c(sequencage,new)
      }
      
      # Puis on va reconstituer la courbe de rarefaction "à la main", avec des tirages aléatoires dans le vecteur sequencage
      # et en même temps le chao1
      richness=chao=NULL
      for (j in seq(1,length(sequencage), by=100)){
        u=sample(as.factor(sequencage), size=j)
        richness=c(richness,length(unique(u)))
        chao=c(chao,chao1(table(u)))
      }

      # On crée un data frame pour associer les bonnes profondeurs de séquencages aux valeurs calculées
      rare_curves=data.frame("deep"=seq(1,length(sequencage), by=100),"Richesse"=richness,"Chao"=chao)

      #on retourne le résultat
      return(rare_curves)

}


```



On peut maintenant tracer les courbes qui nous intéressent :

##### Individu avec la profondeur de séquençage la plus grande: "BG-G-D0-CUFF"
- **Premier cas : tous les OTU** 
```{r}
rare_curves_all <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-G-D0-CUFF")
plot(x=rare_curves_all$deep,y=rare_curves_all$Richesse , ylim=c(0,max(rare_curves_all$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si tous les OTU sont conservés " )
points(x=rare_curves_all$deep,y=rare_curves_all$Chao, col='red')

```

On retrouve en noir la courbe de raréfaction et en rouge l'évolution du Chao1.


- **Deuxième cas : en enlevant les OTU apparus une fois**
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-G-D0-CUFF",filtre_inf = 1)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus 1 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```

Concernant la courbe de rarefaction en noire : le plateau semble plus net, la richesse spécifique se stabilise plus nettement.
Le Chao1 rejoint la richesse spécifique quand la profondeur de séquencage arrive autour de 10 000!


- **Troisième cas : en enlevant les OTU apparus 5 fois ou moins**
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-G-D0-CUFF",filtre_inf = 5)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus moins de 5 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```

Le Chao1 rejoint la richesse spécifique quand la profondeur de séquencage arrive autour de 5 000.
Pour les deux indices, le plateau est tès vite atteint la convergence est nette.


- **Quatrième cas : en enlevant les OTU apparus plus de 50 fois **
Remarque : logiquement cela fait baisser énormément la profondeur de séquencage donc pas une bonne idée
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-G-D0-CUFF",filtre_sup = 50)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus plus de 50 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```




##### Individu avec la profondeur de séquençage la plus petite: "BG-I-D0-CTL"

- **Premier cas : tous les OTU** 
```{r}
rare_curves_all <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-I-D0-CTL")
plot(x=rare_curves_all$deep,y=rare_curves_all$Richesse , ylim=c(0,max(rare_curves_all$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si tous les OTU sont conservés " )
points(x=rare_curves_all$deep,y=rare_curves_all$Chao, col='red')

```

On retrouve en noir la courbe de raréfaction et en rouge l'évolution du Chao1.


- **Deuxième cas : en enlevant les OTU apparus une fois**
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-I-D0-CTL",filtre_inf = 1)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus 1 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```

Concernant la courbe de rarefaction en noire : le plateau semble plus net, la richesse spécifique se stabilise plus nettement.
Le Chao1 rejoint la richesse spécifique quand la profondeur de séquencage arrive autour de 6 000!


- **Troisième cas : en enlevant les OTU apparus 5 fois ou moins**
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-I-D0-CTL",filtre_inf = 5)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus moins de 5 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```

Le Chao1 rejoint la richesse spécifique quand la profondeur de séquencage arrive autour de 3 500.
Pour les deux indices, le plateau est très vite atteint la convergence est nette.



- **Quatrième cas : en enlevant les OTU apparus plus de 50 fois **
Remarque : logiquement cela fait baisser énormément la profondeur de séquencage donc pas une bonne idée
```{r}
rare_curves <- RARE_CURVE_RICHNESS_CHAO(indiv = "BG-I-D0-CTL",filtre_sup = 50)
plot(x=rare_curves$deep,y=rare_curves$Richesse , ylim=c(0,max(rare_curves$Chao)), main="Evolution richesse spécifique (noir) et Chao1 (rouge) \n si les OTU apparus plus de 50 fois sont supprimés " )
points(x=rare_curves$deep,y=rare_curves$Chao, col='red')

```




## Indice de Simpson

Interprétation : La probabilité que deux bactéries tirées au hasard dans l'échantillon soient d'espèces différentes:  
- Quand simpson tend vers 0 : une espèce domine les autres, peu de diversification   
- Quand simpson tend vers 1 : grande diversification  

```{r}
#Simpson
SIMPSON=diversity(matrix_otu, index='simpson')
plot(SIMPSON,main="Indice de Simpson pour les 28 sujets ")
```
Globalement, indices de SIMPSON élevés (proches de 1) : proba élevée de tomber sur deux bactéries différentes.

Est-ce que les sujets avec les indices un peu plus faible sont ceux avec la profondeur de séquençage la plus faible ?
On peut regarder la corrélation entre la profondeur de séquençage et l'indice de SIMPSON:

**Lien avec la profondeur de séquençage**
```{r}
profondeur_sequencage <- apply(matrix_otu, 1, sum)
plot(x=profondeur_sequencage,SIMPSON, main="SIMPSON en fonction de la profondeur de séquencage \n pour les 28 sujets")
```

```{r}
summary(lm(SIMPSON~profondeur_seq))
```


Il n'existe pas de lien linéaire entre SIMPSON et la profondeur de séquencage.

Peut être car de toute façon la profondeur de séquencage est suffisamment élevée dans tous les cas.

**Lien avec la richesse**
```{r}
plot(RICHNESS,SIMPSON, main="SIMPSON en fonction de la richesse spécifique \n pour les 28 sujets")
```

```{r}
summary(lm(SIMPSON~RICHNESS))
```
Cette fois on a une très légère corrélation positive.


**En faisant varier la taille des séquences**
```{r}
RARE_CURVE_SIMPSON <- function(indiv,filtre_inf = 0,filtre_sup = max(ind)){
      #on choisit un individu 
      ind= matrix_otu[indiv,]
      ind= t(ind[which(ind>filtre_inf & ind<=filtre_sup)])
      
      # On veut passer d'un vecteur de comptage aux données de séquençage d'origine
      # on va donc répéter le nom des OTU autant de fois qu'ils ont été comptés et en faire un vecteur
      sequencage=NULL
      for (i in 1:length(ind)){
        new=rep(rownames(ind)[i], ind[i])
        sequencage=c(sequencage,new)
      }
      
      # Puis on regarde l'évolution de simpson selon la taille de la séquence
      simpson=NULL
      for (j in seq(1,length(sequencage), by=100)){
        u=sample(as.factor(sequencage), size=j)
        simpson=c(simpson,diversity(table(u), index='simpson'))
      }

      # On crée un data frame pour associer les bonnes profondeurs de séquencages aux valeurs calculées
      rare_curves=data.frame("deep"=seq(1,length(sequencage), by=100),"simpson"=simpson)

      #on retourne le résultat
      return(rare_curves)

}

```

- avec **aucun filtre** :
```{r}
rare_curves <- RARE_CURVE_SIMPSON(indiv = "BG-I-D0-CTL")
plot(x=rare_curves$deep,y=rare_curves$simpson , main="Evolution indice de simpson selon profondeur de séquençage \n en conservant tous les OTU" )

```

- en **enlevant les OTU apparus 1 fois** :
```{r}
rare_curves <- RARE_CURVE_SIMPSON(indiv = "BG-I-D0-CTL",filtre_inf = 1)
plot(x=rare_curves$deep,y=rare_curves$simpson , main="Evolution indice de simpson selon profondeur de séquençage \n si les OTU apparus 1 fois sont supprimés" )

```

- en **enlevant les OTU apparus moins de 5 fois** :
```{r}
rare_curves <- RARE_CURVE_SIMPSON(indiv = "BG-I-D0-CTL",filtre_inf=5)
plot(x=rare_curves$deep,y=rare_curves$simpson , main="Evolution indice de simpson selon profondeur de séquençage \n si les OTU apparus moins de 5 fois sont supprimés" )

```

Enlever les OTU apparus peu de fois n'impacte pas l'indice de SIMPSON, on a toujours une grande proba de tomber sur 2 OTU différents.


- en **enlevant les OTU apparus plus de 50 fois** :
```{r}
rare_curves <- RARE_CURVE_SIMPSON(indiv = "BG-I-D0-CTL",filtre_sup=50)
plot(x=rare_curves$deep,y=rare_curves$simpson , main="Evolution indice de simpson selon profondeur de séquençage \n si les OTU apparus plus de 50 fois sont supprimés" )

```
Là encore l'indice de Simpson reste très élevé au bout de peu de séquencage





## Indice de Shannon
```{r}
#Shannon
SHANNON<-diversity(matrix_otu, index='shannon')
plot(SHANNON,main="Indice de Shannon pour les 28 sujets ")
```

!! pas une probabilité contrairement à Simpson, souvent entre 1 et 5.

La valeur de l’indice varie de :  
- 0 (une seule espèce, ou bien une espèce dominant très largement toutes les autres)     
- à log(S) (lorsque toutes les espèces ont même abondance). 



Est-ce que les sujets avec les indices un peu plus faible sont ceux avec la profondeur de séquençage la plus faible ?
On peut regarder la corrélation entre la profondeur de séquençage et l'indice de Shannon:

**Lien avec la profondeur de séquençage**
```{r}
profondeur_sequencage <- apply(matrix_otu, 1, sum)
plot(x=profondeur_sequencage,SHANNON, main="SHANNON en fonction de la profondeur de séquencage \n pour les 28 sujets")
```

```{r}
summary(lm(SHANNON~profondeur_seq))
```

Il n'existe pas de lien linéaire entre SHANNON et la profondeur de séquencage.

Peut être car de toute façon la profondeur de séquencage est suffisamment élevée dans tous les cas.

**Lien avec la richesse**
```{r}
plot(RICHNESS,SHANNON, main="SHANNON en fonction de la richesse spécifique \n pour les 28 sujets")
```

```{r}
summary(lm(SHANNON~RICHNESS))
```
Cette fois on a une corrélation positive.


**En faisant varier la taille des séquences**
```{r}
RARE_CURVE_SHANNON <- function(indiv,filtre_inf = 0,filtre_sup = max(ind)){
      #on choisit un individu 
      ind= matrix_otu[indiv,]
      ind= t(ind[which(ind>filtre_inf & ind<=filtre_sup)])
      
      # On veut passer d'un vecteur de comptage aux données de séquençage d'origine
      # on va donc répéter le nom des OTU autant de fois qu'ils ont été comptés et en faire un vecteur
      sequencage=NULL
      for (i in 1:length(ind)){
        new=rep(rownames(ind)[i], ind[i])
        sequencage=c(sequencage,new)
      }
      
      # Puis on regarde l'évolution de simpson selon la taille de la séquence
      shannon=NULL
      for (j in seq(1,length(sequencage), by=100)){
        u=sample(as.factor(sequencage), size=j)
        shannon=c(shannon,diversity(table(u), index='shannon'))
      }

      # On crée un data frame pour associer les bonnes profondeurs de séquencages aux valeurs calculées
      rare_curves=data.frame("deep"=seq(1,length(sequencage), by=100),"shannon"=shannon)

      #on retourne le résultat
      return(rare_curves)

}

```

- avec **aucun filtre** :
```{r}
rare_curves <- RARE_CURVE_SHANNON(indiv = "BG-I-D0-CTL")
plot(x=rare_curves$deep,y=rare_curves$shannon , main="Evolution indice de shannon selon profondeur de séquençage \n en conservant tous les OTU" )

```

- en **enlevant les OTU apparus 1 fois** :
```{r}
rare_curves <- RARE_CURVE_SHANNON(indiv = "BG-I-D0-CTL",filtre_inf = 1)
plot(x=rare_curves$deep,y=rare_curves$shannon , main="Evolution indice de shannon selon profondeur de séquençage \n si les OTU apparus 1 fois sont supprimés" )

```

- en **enlevant les OTU apparus moins de 5 fois** :
```{r}
rare_curves <- RARE_CURVE_SHANNON(indiv = "BG-I-D0-CTL",filtre_inf=5)
plot(x=rare_curves$deep,y=rare_curves$shannon , main="Evolution indice de shannon selon profondeur de séquençage \n si les OTU apparus moins de 5 fois sont supprimés" )

```

Enlever les OTU apparus peu de fois n'impacte pas vraiment l'indice de SIMPSON


- en **enlevant les OTU apparus plus de 50 fois** :
```{r}
rare_curves <- RARE_CURVE_SHANNON(indiv = "BG-I-D0-CTL",filtre_sup=50)
plot(x=rare_curves$deep,y=rare_curves$shannon , main="Evolution indice de shannon selon profondeur de séquençage \n si les OTU apparus plus de 50 fois sont supprimés" )

```




**RQ**
```{r}
plot(SIMPSON,SHANNON)
```
Les deux indices sont très corrélés, normal qu'on arrive aux mêmes conclusions...





## Les données suivent loi log-normale ?


```{r}
#essai sur sujet 1
ind <- sort(matrix_otu[1,which(matrix_otu[1,]!=0)],decreasing = T)

plot(x=1:259,y=ind)

```


Loi log-normale semble possible. 

```{r}
log(apply(ind,1,FUN=mean))
log(apply(ind,1,FUN=sd))
```



```{r}
library(stats)
```

```{r}
simul_ln <- rlnorm(80, meanlog = 1, sdlog =1.5)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)

library(vegan)
divers=richness=NULL
n=80
for(i in seq(0, 10, by=0.5)){
  simul_ln <- rlnorm(n, meanlog = 1, sdlog =i)
  simul_ln_int <- floor(simul_ln)
  plot(simul_ln)
  divers= c(divers, diversity(simul_ln_int, index='simpson'))
  richness=c(richness,length(unique(simul_ln_int)))
}
plot(divers)
plot(richness)

###Commence à se destructurer à partir de 2-3 sd
plot(sort(floor(rlnorm(n, meanlog = 1, sdlog =4)),decreasing =T))
```

```{r}
simul_ln <- rlnorm(13000, meanlog = 1, sdlog =1)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)
```


```{r}
simul_ln <- rlnorm(13000, meanlog = 1, sdlog =3/4)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)
```

```{r}
simul_ln <- rlnorm(13000, meanlog = 1, sdlog =2/3)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)
```

```{r}
simul_ln <- rlnorm(13000, meanlog = 1, sdlog =1/2)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)
```


```{r}
simul_ln <- rlnorm(13000, meanlog = 1, sdlog =1/5)
simul_ln_int <- ceiling(simul_ln)
hist(simul_ln_int,breaks = 60)
```








## DIVERSITE ARBRE PHYLOGENETIQUE
https://fr.wikipedia.org/wiki/Diversit%C3%A9_phylog%C3%A9n%C3%A9tique
Mesures
De très nombreux indices de diversité phylogénétique ont été développés avec les années. Il existe plus de 70 mesures de la diversité phylogénétique, dont plusieurs sont fortement corrélées5. Certains indices ont incorporé l’abondance des différentes unités taxonomiques dans le calcul. Ainsi, pour ces indices, les espèces abondantes ont un poids supérieur ou inférieur comparativement aux espèces rares. D’autres comparent différents ensembles de taxa, un peu comme le fait la diversité bêta. Par exemple, certains indices calculent la longueur des branches des espèces uniques à chaque site. Finalement, certains indices combinent la diversité phylogénétique et le nombre d'espèces. Tous ces indices peuvent être divisés en trois catégories selon ce qu’ils cherchent à mesurer : la richesse, la divergence et la régularité.


Les indices de diversité phylogénétiques peuvent être divisés en trois catégories : Richesse, divergence et régularité. La figure est inspirée de l'article de Caroline Tucker et collaborateurs5.
Richesse
Les mesures de richesse phylogénétique servent à quantifier la différence phylogénétique d’un ensemble de taxa5. Ainsi, ces indices permettent de mesurer l’histoire évolutive accumulée par un ensemble de taxa. L'indice le plus commun est la diversité phylogénétique proposée par Faith1. Celle-ci fait la somme des longueurs de branches de l’arbre incluant tous les membres de l’ensemble. Au lieu d'utiliser la longueur des branches, d'autres indices font la somme de la distance entre toutes les paires d'espèces d'un ensemble.

Divergence
Les mesures de divergence cherchent à quantifier la distribution des taxa d’un ensemble5. Par exemple, il est possible de calculer la divergence phylogénétique en divisant la richesse phylogénétique par la richesse spécifique. Ainsi, on obtient la longueur de branches moyennes reliant chaque unité taxonomique. Une autre mesure courante de la divergence est de calculer la moyenne des longueurs de branches entre chaque paire de taxa. Ainsi, on mesure la distance phylogénétique moyenne entre les taxa. Ces indices servent donc à quantifier la différence entre les unités taxonomiques d’un ensemble d’intérêt.

Régularité
La régularité mesure à quel point les taxa d’un ensemble sont également distancés phylogénétiquement5. En d’autres mots, on compare la distribution des taxa d’une phylogénie à un arbre phylogénétique dont tous les taxa ont une distance évolutive égale. La régularité est maximale lorsque toutes les paires d’espèces sont également distancées sur l’arbre phylogénétique. Au contraire, si certaines espèces sont très proches et d'autres éloignées, la régularité sera inférieure. Une mesure permettant de quantifier cette régularité phylogénétique est la variance des distances entre chaque paire d’un ensemble.

